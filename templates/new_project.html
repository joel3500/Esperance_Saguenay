{% extends "base.html" %}
{% block content %}

{% if project %}
  <h2>Modifier le projet</h2>
{% else %}
  <h2>Nouveau projet</h2>
{% endif %}

<form method="post" enctype="multipart/form-data" class="form-vertical">

  <!-- Ville du projet, préremplie avec la ville de l'utilisateur ou celle du projet -->
  <label for="ville">Ville du projet</label>
  <input
    type="text"
    id="ville"
    name="ville"
    placeholder="Ville du projet"
    value="{{ (project.ville if project else current_user.ville) or '' }}"
  >

  <!-- Description -->
  <label for="description">Description du projet</label>
  <textarea id="description" name="description" rows="5" required>
{{ project.description if project else '' }}</textarea>

  <!-- ======= BESOINS (dynamiques) ======= -->
  <h3>Liste des besoins</h3>

  <div id="besoins-container">
      <!-- Une 1re ligne par défaut -->
      <div class="besoin-row">
        <input type="text" name="besoins_texte"
              placeholder="Ex : Collations pour l'événement">

        <input type="number" name="besoins_montant"
              min="0"
              placeholder="Montant en $ (laisser vide si non financier)">

        <button type="button" class="remove-besoin">Supprimer</button>
      </div>
  </div>

  <button type="button" id="add-besoin">+ Ajouter un besoin</button>

  <!-- ======= LIENS URL (dynamiques) ======= -->
  <h3>Liens URL (optionnel)</h3>

  <div id="urls-container">
    {% set liens = project.links if project else [] %}
    {% if liens %}
      {% for l in liens %}
        <div class="url-row">
          <input type="url" name="urls" value="{{ l.url }}">
          <button type="button" class="remove-url">Supprimer</button>
        </div>
      {% endfor %}
    {% else %}
      <div class="url-row">
        <input type="url" name="urls" placeholder="https://exemple.com">
        <button type="button" class="remove-url">Supprimer</button>
      </div>
    {% endif %}
  </div>

  <button type="button" id="add-url">+ Ajouter un lien</button>

  <!-- Médias -->
  <h3>Médias du projet</h3>
  {% if project and project.medias %}
    <p>Médias déjà enregistrés :</p>
    <ul>
      {% for m in project.medias %}
        <li>{{ m.filename }} ({{ m.media_type }})</li>
      {% endfor %}
    </ul>
    <p>Vous pouvez ajouter d'autres fichiers ci-dessous (les fichiers existants seront conservés).</p>
  {% endif %}
  <input type="file" name="medias" multiple>

  <button type="submit">
    {% if project %}Enregistrer les modifications{% else %}Enregistrer le projet{% endif %}
  </button>
</form>

  <!-- Script JS pour gérer les champs dynamiques -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const besoinsContainer = document.getElementById('besoins-container');
      const addBesoinBtn = document.getElementById('add-besoin');

      function attachRemoveBesoin(btn) {
        btn.addEventListener('click', function () {
          const row = btn.parentElement;
          besoinsContainer.removeChild(row);
        });
      }

      function createBesoinRow(texteValue = "", montantValue = "") {
        const row = document.createElement('div');
        row.className = 'besoin-row';

        const inputTexte = document.createElement('input');
        inputTexte.type = 'text';
        inputTexte.name = 'besoins_texte';
        inputTexte.placeholder = "Ex : Collations pour l'événement";
        inputTexte.value = texteValue;

        const inputMontant = document.createElement('input');
        inputMontant.type = 'number';
        inputMontant.name = 'besoins_montant';
        inputMontant.min = "0";
        inputMontant.placeholder = "Montant en $ (laisser vide si non financier)";
        if (montantValue !== "" && montantValue !== null) {
          inputMontant.value = montantValue;
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-besoin';
        removeBtn.textContent = 'Supprimer';
        attachRemoveBesoin(removeBtn);

        row.appendChild(inputTexte);
        row.appendChild(inputMontant);
        row.appendChild(removeBtn);

        return row;
      }

      addBesoinBtn.addEventListener('click', function () {
        const newRow = createBesoinRow();
        besoinsContainer.appendChild(newRow);
      });

      // Attache les listeners "Supprimer" aux lignes déjà présentes
      besoinsContainer.querySelectorAll('.remove-besoin').forEach(attachRemoveBesoin);
    });
  </script>

{% endblock %}
