{% extends "base.html" %}
{% block content %}

  <article class="project-detail">
    <header>
        <h2>Projet #{{ project.id }}</h2>
        <p>
            <strong>{{ project.createur.prenom }} {{ project.createur.nom }}</strong>
            – {{ project.ville or "Ville inconnue" }}<br>
            <small> <font color="blue">Soumis le {{ project.created_at.strftime("%d/%m/%Y à %H:%M") }} </font> </small>
        </p>

        {% if current_user and current_user.id == project.createur.id %}
          <p>
            <a href="{{ url_for('edit_project', project_id=project.id) }}">
              Apporter une modification à ce projet
            </a>
          </p>
        {% endif %}
    </header>

    <section>
      <h3>Description du projet</h3>
      <p>{{ project.description | nl2br }}</p>
    </section>

    <section>
      <h3>Besoins</h3>
      {% if project.needs %}
        <ul>
          {% for besoin in project.needs %}
            <li>{{ besoin.texte }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p>Aucun besoin détaillé.</p>
      {% endif %}
    </section>

    <section>
       ON pourrait aussi placer les contributions aux besoins ici
    </section>

    <section>
      <h3>Galerie du Projet</h3>
      {% if project.medias %}
        <div class="media-grid">
          {% for m in project.medias %}
            {% if m.media_type == "image" %}
              <img src="{{ url_for('static', filename='uploads/' ~ m.filename) }}"
                  alt="media {{ loop.index }}">
            {% else %}
              <video controls>
                <source src="{{ url_for('static', filename='uploads/' ~ m.filename) }}">
                Votre navigateur ne supporte pas la vidéo.
              </video>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <p>Aucun média pour le moment.</p>
      {% endif %}
    </section>

    <section>
      <h3>Liens utiles</h3>
      {% if project.links %}
        <ul>
          {% for l in project.links %}
            <li><a href="{{ l.url }}" target="_blank">{{ l.url }}</a></li>
          {% endfor %}
        </ul>
      {% else %}
        <p>Aucun lien ajouté.</p>
      {% endif %}
    </section>

    <section>
        <ul>
          {% for need in needs %}
            <li>
              {{ need.texte }}

              {% if need.is_money and need.amount_goal %}
                {% set total = contributions_by_need.get(need.id, 0) %}
                {% set remaining = need.amount_goal - total %}
                <div class="money-need">
                  Besoin financier : {{ need.amount_goal }} $
                  <br>
                  Déjà promis : {{ total }} $
                  <br>
                  Reste à combler : {{ remaining if remaining > 0 else 0 }} $
                </div>

                {% if current_user %}
                  <form action="{{ url_for('contribute_to_need', need_id=need.id) }}" method="post" class="contrib-form">
                    <label>Je souhaite contribuer :</label>
                    <input type="number" name="amount" min="1" max="{{ remaining if remaining > 0 else need.amount_goal }}" required>
                    <button type="submit">Contribuer</button>
                  </form>
                {% else %}
                  <p><a href="{{ url_for('login') }}">Connectez-vous</a> pour contribuer à ce besoin.</p>
                {% endif %}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
    </section>

  </article><br><br>

  <hr> <!--======================= la grande barre avant les commentaires ==============================-->

    <section class="comments">
      <h3>Commentaires</h3>

      {% if current_user %}
        <form method="post" action="{{ url_for('add_comment', project_id=project.id) }}" class="comment-form">
          <label for="contenu">Poster une nouvelle intervention</label><br>
          <textarea name="contenu" id="contenu" rows="3" required></textarea><br>
          <button type="submit">Envoyer</button>
        </form>
      {% else %}
        <p>Pour commenter, veuillez <a href="{{ url_for('login') }}">vous connecter</a>.</p>
      {% endif %}

      <div class="comment-list">
        {% for c in comments %}
          <div class="comment">
            <p class="comment-meta">
                <strong>{{ c.auteur.prenom }} {{ c.auteur.nom }}</strong>
                <font color="blue"> 
                    – {{ c.created_at.strftime("%d/%m/%Y à %H:%M") }} 
                    {% if c.updated_at > c.created_at %}
                    <em>(modifié)</em>
                    {% endif %}
                </font>
            </p>
            <p>{{ c.contenu | nl2br }}</p>

            {% if current_user and current_user.id == c.auteur.id %}
              <form method="get" action="{{ url_for('edit_comment', comment_id=c.id) }}" class="inline-form">
                <button type="submit">Modifier</button>
              </form>
              <form method="post" action="{{ url_for('delete_comment', comment_id=c.id) }}" class="inline-form">
                <button type="submit" onclick="return confirm('Supprimer ce commentaire ?');">
                  Supprimer
                </button>
              </form>
            {% endif %}

            {% if current_user %}
              <form method="post"
                    action="{{ url_for('add_comment', project_id=project.id) }}"
                    class="reply-form">
                <input type="hidden" name="parent_id" value="{{ c.id }}">
                <textarea name="contenu" rows="2" placeholder="Répondre..."></textarea>
                <button type="submit">Répondre</button>
              </form>
            {% endif %}

            {% for r in c.replies %}
              <div class="comment reply">
                <p class="comment-meta">
                  <strong>{{ r.auteur.prenom }} {{ r.auteur.nom }}</strong>
                  <font color="blue"> – {{ r.created_at.strftime("%d/%m/%Y à %H:%M") }} </font>
                </p>
                <p>{{ r.contenu | nl2br }}</p>

                {% if current_user and current_user.id == r.auteur.id %}
                  
                    <form method="get" action="{{ url_for('edit_comment', comment_id=r.id) }}" class="inline-form">
                      <button type="submit">Modifier</button>
                    </form>

                    <form method="post" action="{{ url_for('delete_comment', comment_id=r.id) }}" class="inline-form">
                      <button type="submit" onclick="return confirm('Supprimer ?');">Supprimer</button>
                    </form>
                    <br><br>
                {% endif %}
              </div>
            {% endfor %}

          </div>
        {% else %}
          <p>Pas encore de commentaires.</p>
        {% endfor %}

      </div>
    </section>

    {% if current_user and current_user.id == project.createur.id %}
      <section>
          <form action="{{ url_for('delete_project', project_id=project.id) }}"
              method="post"
              onsubmit="return confirm('Voulez-vous vraiment supprimer ce projet ? Cette action est définitive.');">
              <button type="submit">Supprimer ce projet</button>
          </form>
      </section>
    {% endif %}

{% endblock %}
